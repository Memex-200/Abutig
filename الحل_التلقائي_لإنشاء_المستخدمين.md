# الحل التلقائي لإنشاء المستخدمين

## المشكلة

الادمن يحتاج لإنشاء مستخدمين جدد، لكن العملية تتطلب تدخل يدوي في قاعدة البيانات.

## الحل التلقائي

### الخطوة 1: إعداد النظام

شغل هذا السكريبت في Supabase SQL Editor:

```sql
-- Copy and paste the contents of supabase/admin_user_creation.sql
```

### الخطوة 2: تحديث واجهة الادمن

تم تحديث `AdminDashboard.tsx` لاستخدام `supabase.auth.admin.createUser()`.

### الخطوة 3: إنشاء المستخدمين تلقائياً

الآن عندما ينشئ الادمن مستخدم جديد:

1. **يتم إنشاء حساب المصادقة** في Supabase Auth تلقائياً
2. **يتم إنشاء الملف الشخصي** في جدول `users` تلقائياً
3. **يتم ربط الحسابين** تلقائياً
4. **المستخدم جاهز لتسجيل الدخول** فوراً

## كيفية الاستخدام

### للادمن:

1. اذهب إلى **Admin Dashboard**
2. اضغط **"إضافة مستخدم جديد"**
3. املأ البيانات:
   - الاسم الكامل
   - البريد الإلكتروني
   - كلمة المرور
   - الهاتف (اختياري)
   - الرقم القومي (اختياري)
   - الدور (موظف/إداري)
4. اضغط **"حفظ"**

### للمستخدم الجديد:

1. اذهب إلى صفحة **تسجيل الدخول**
2. اختر تبويب **"موظف/إداري"**
3. أدخل البريد الإلكتروني وكلمة المرور
4. اضغط **"تسجيل الدخول"**

## الدوال المتاحة

### 1. إنشاء مستخدم جديد:

```sql
SELECT public.admin_create_user(
  'user@example.com',
  'password123',
  'اسم المستخدم',
  '01234567890',
  '12345678901234',
  'EMPLOYEE'
);
```

### 2. ربط الملفات الشخصية تلقائياً:

```sql
SELECT public.auto_link_profiles();
```

### 3. فحص حالة المستخدم:

```sql
SELECT public.check_user_status('user@example.com');
```

## المميزات

✅ **إنشاء تلقائي** - لا حاجة للتدخل اليدوي
✅ **ربط تلقائي** - بين Auth و Profile
✅ **فحص الحالة** - للتأكد من جاهزية المستخدم
✅ **أمان كامل** - فقط الادمن يمكنه إنشاء مستخدمين
✅ **رسائل واضحة** - في حالة وجود أي مشاكل

## ملاحظات مهمة

- **يجب أن يكون الادمن مسجل دخول** لإنشاء مستخدمين
- **كلمة المرور آمنة** - يتم تشفيرها في Supabase Auth
- **البريد الإلكتروني فريد** - لا يمكن تكراره
- **الربط تلقائي** - لا حاجة لربط يدوي

## إذا واجهت مشاكل

1. **تحقق من صلاحيات الادمن:**

```sql
SELECT role, is_active FROM public.users WHERE auth_user_id = auth.uid();
```

2. **فحص حالة المستخدم:**

```sql
SELECT public.check_user_status('user@example.com');
```

3. **ربط يدوي إذا لزم الأمر:**

```sql
SELECT public.auto_link_profiles();
```

الآن يمكن للادمن إنشاء مستخدمين جدد بسهولة دون الحاجة للتدخل اليدوي في قاعدة البيانات!
